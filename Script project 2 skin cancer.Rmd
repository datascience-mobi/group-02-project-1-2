---
title: "Project 2 - skin cancer"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

loading our data 



Data Clean up 

namecelllines was defined as all the celllines with skin cancer as their primary disease
```{r}
namescelllines = allDepMapData$annotation$DepMap_ID[which(allDepMapData$annotation$Primary.Disease == 'Skin Cancer')]
```

Extraction of the skin cancer cell lines out of all the matrices
```{r}
allDepMap_expression_SkinCancer =  allDepMapData$expression[ ,which(colnames(allDepMapData$expression) %in% namescelllines)]
allDepMap_mutation_SkinCancer =  allDepMapData$mutation[match(x = namescelllines, table = names(allDepMapData$mutation))]
allDepMap_copynumber_SkinCancer =  allDepMapData$copynumber[ ,which(colnames(allDepMapData$copynumber) %in% namescelllines)]
allDepMap_kd.ceres_SkinCancer =  allDepMapData$kd.ceres[ ,which(colnames(allDepMapData$kd.ceres) %in% namescelllines)]
allDepMap_kd.prob_SkinCancer =  allDepMapData$kd.prob[ ,which(colnames(allDepMapData$kd.prob) %in% namescelllines)]
allDepMap_annotation_SkinCancer =  allDepMapData$annotation[which(allDepMapData$annotation$DepMap_ID %in% namescelllines), ]
```

```{r}
a = 1
while (a < length(names(allDepMap_mutation_SkinCancer))) { 
  allDepMap_mutation_SkinCancer[[a]] = allDepMap_mutation_SkinCancer[[a]][allDepMap_mutation_SkinCancer[[a]][,"isDeleterious"]==TRUE, ]
  a = a+1
}
```

deleting missing values out of the mutation matrix
```{r}
i = 1
while (i < length(names(allDepMap_mutation_SkinCancer))) {
  
  rmv.rows = apply (allDepMap_mutation_SkinCancer[[i]], 2, function (x){sum(is.na(x))})
  allDepMap_mutation_SkinCancer[[i]] = allDepMap_mutation_SkinCancer[[i]][, -which(rmv.rows>0)]
  i = i+1
}
```


```{r}
a = 1
while(a< 35){
  allDepMap_mutation_SkinCancer[[a]] = allDepMap_mutation_SkinCancer[[a]][order(allDepMap_mutation_SkinCancer[[a]][,2]), ]
  a = a+1
}

a = 1
while (a<35) {print(length(colnames(allDepMap_mutation_SkinCancer[[a]]))); a = a+1;}

a = 1
while (a<35) {
  allDepMap_mutation_SkinCancer[[a]] = allDepMap_mutation_SkinCancer[[a]][,colnames(allDepMap_mutation_SkinCancer[[33]])]
  a = a+1
}

mymatrix <- rbind(allDepMap_mutation_SkinCancer[[1]],allDepMap_mutation_SkinCancer[[2]])

a = 3
while (a<35) {mymatrix <- rbind(mymatrix,allDepMap_mutation_SkinCancer[[a]])
a = a+1   
}

Mutation_1dataframe <- mymatrix
rm(mymatrix)

length(unique(Mutation_1dataframe$Hugo_Symbol))

Mutation_1dataframe = Mutation_1dataframe[order(Mutation_1dataframe$Chromosome),]

Mutation_1dataframe = Mutation_1dataframe[order(Mutation_1dataframe$Start_position),]

Mutation_1dataframe = Mutation_1dataframe[order(Mutation_1dataframe$Hugo_Symbol),]
```

ordering the rows after the rownames alphabetically of the copynumber and the expression matrix 
```{r}
allDepMap_copynumber_SkinCancer = allDepMap_copynumber_SkinCancer[order(rownames(allDepMap_copynumber_SkinCancer)),]
allDepMap_expression_SkinCancer = allDepMap_expression_SkinCancer[order(rownames(allDepMap_expression_SkinCancer)),]
```

defining the rownames of the annotation matrix as the ID -> the celllines
```{r}
rownames(allDepMap_annotation_SkinCancer)= allDepMap_annotation_SkinCancer$DepMap_ID
```

deleting the columns with the names ID, Aliases, Gender, Source
```{r}
allDepMap_annotation_SkinCancer = allDepMap_annotation_SkinCancer[ , -which(colnames(allDepMap_annotation_SkinCancer) %in% c("DepMap_ID", "Aliases", "Gender", "Source")) ]
```

which Cellines don't have the subtype disease melanoma?
```{r}
which(allDepMap_annotation_SkinCancer$Subtype.Disease != "Melanoma")
```

reorder the rows of the annotation matrix to gruop the cellines after the subtype diseases
```{r}
allDepMap_annotation_SkinCancer = allDepMap_annotation_SkinCancer[c(1:13, 15:19, 21:26, 28:30, which(allDepMap_annotation_SkinCancer$Subtype.Disease != "Melanoma")), ]
allDepMap_annotation_SkinCancer$Subtype.Disease = factor(allDepMap_annotation_SkinCancer$Subtype.Disease)
allDepMap_annotation_SkinCancer$Primary.Disease = factor(allDepMap_annotation_SkinCancer$Primary.Disease)
```

looking for missing values in the ceres and the probability matrix -> there are none, then ordering the rows alphabetically after the rownames which equal the gene names
```{r}
rmv.rows = apply(allDepMap_kd.ceres_SkinCancer, 1, function(x) {sum(is.na(x))})
allDepMap_kd.ceres_SkinCancer = allDepMap_kd.ceres_SkinCancer[order(rownames(allDepMap_kd.ceres_SkinCancer)), ]

rmv.rows = apply(allDepMap_kd.prob_SkinCancer, 1, function(x) {sum(is.na(x))})
allDepMap_kd.prob_SkinCancer = allDepMap_kd.prob_SkinCancer[order(rownames(allDepMap_kd.prob_SkinCancer)), ]
```

cleaning the copynumber matrix -> deleting all rows which contain missing values
```{r}
rmv.rows = apply(allDepMap_copynumber_SkinCancer, 1, function(x) {sum(is.na(x))})
which(rmv.rows > 0)
allDepMap_copynumber_SkinCancer = allDepMap_copynumber_SkinCancer[-which(rmv.rows > 0), ]
allDepMap_copynumber_SkinCancer = allDepMap_copynumber_SkinCancer[order(rownames(allDepMap_copynumber_SkinCancer)), ]
```


Cleaning the expression matrix -> no missing values 
```{r}
mis.val = apply(allDepMap_expression_SkinCancer, 1, function(x) {sum(is.na(x))})

mis.val [1:10]

which(mis.val > 0)
```


Data visualization 

boxplts from the expression matrix the first one is only of the first cellline and the second plot is of all celllines
```{r}
boxplot(allDepMap_expression_SkinCancer$`ACH-000014`, main = "ACH-000014", xlab = "Expressionvalue", horizontal = T)
boxplot(allDepMap_expression_SkinCancer , main = "overview", xlab= "cell  lines", ylab = "values")
```

Creating a heatmap of the ceres matrix. The computer was a bit overcharged with the whole matrix so we created a smaller matrix and created a heatmap from it. THe same we did for the porbability matrix.
```{r}
matrix.klein = allDepMap_kd.ceres_SkinCancer [1:20, 1:34]
heatmap(as.matrix(matrix.klein))
matrix.kleinprob = allDepMap_kd.prob_SkinCancer [1:20, 1:34]
heatmap(as.matrix(matrix.kleinprob))
```

orderning the rownames of the expression marix alphabetically
```{r}
allDepMap_expression_SkinCancer = allDepMap_expression_SkinCancer[order(rownames(allDepMap_expression_SkinCancer)),]
```

searching for rownames which contain 'BRAF' and creating a matrix containing all rows with 'BRAF'. Name of the new matrix: BRAFexpression. And creating a boxplot of this matrix
```{r}
which(rownames(allDepMap_expression_SkinCancer) == "BRAF")
BRAFexpression <-allDepMap_expression_SkinCancer[which(rownames(allDepMap_expression_SkinCancer) == "BRAF"),]
boxplot(BRAFexpression)
```

We performed the same procedure for 'RAS'. BUt there were no genes called 'RAS' so we saw in the list that there were genes containing 'RAS' in der name. We searched for them. Because the list was ordered alphabetically they were all close together. We identified the rows containing those genes and created a matrix with those genes. Aditionally we created a boxplot. 
```{r}
which(rownames(allDepMap_expression_SkinCancer) == "RARS")
which(rownames(allDepMap_expression_SkinCancer) == "RASSF9")
RASexpression <- allDepMap_expression_SkinCancer[27136:27181,]
boxplot(RASexpression)
```

Performing the same procedure for 'NF'
```{r}
which(rownames(allDepMap_expression_SkinCancer) == "NF1")
which(rownames(allDepMap_expression_SkinCancer) == "NF1P8")
NF1expression <- allDepMap_expression_SkinCancer[22721:22729,]
boxplot(NF1expression)
```

SAme procedure for 'WT'
```{r}
which(rownames(allDepMap_expression_SkinCancer) == "WT1")
which(rownames(allDepMap_expression_SkinCancer) == "WTIP")
WTexpression <- allDepMap_expression_SkinCancer[47802:47806,]
boxplot(WTexpression)
```

Binding the different matrices together. The new matrix is called 'Drivermutation.expr'. From this matrix we created a boxplot.
```{r}
rbind(BRAFexpression, RASexpression, NF1expression, WTexpression)
Drivermutation.expr <- rbind(BRAFexpression, RASexpression, NF1expression, WTexpression)
boxplot(Drivermutation.expr)
```

Looking at the variance in expression of the RASexpession matrix and creating a histogram
```{r}
RASexpression1 = apply(RASexpression, 1, function(x){var(x)})
RASexpression1
hist(RASexpression1)
```

The same we performed for the NF1expression matrix and the WTexpression matrix.#
```{r}
NF1expression1 = apply(NF1expression, 1, function(x){var(x)})
hist(NF1expression1)
WTexpression1 = apply(WTexpression, 1,function(x){var(x)})
hist(WTexpression1)
```
     
     
creating a Barplot with the data of the Drivermutationmatrix
so we can see the expression of the different genes over all celllines. 
The first barplot has the cellines in the x-axis and the expression of all mutations in the y-axis so we see the expression of all genes in the celllines
```{r}     
barplot(as.matrix(Drivermutation.expr[-1,-1]))
```
    
We want to have the genes in the x-axis so i created a new matrix with the rows and columns of the drivermutation.expr swapped
```{r}
df2 <- data.frame(t(Drivermutation.expr[-2, -2]))
```
     
creating a barplot with this new matrix df2
the genes are the x-axis and the expression is the y-axis over all celllines.The lines in the bars are the celllines -> so we can see in which celline how much of this gene is expressed
```{r}     
barplot(as.matrix(df2[-1,-1]))
```
Boxplot over the same data 
```{r}     
boxplot(as.matrix(df2[-1, -1]))
```

Show rownames of matrix to compare if they all show the genes in rownames
```{r}
rownames(Drivermutation.expr)
rownames(allDepMap_kd.ceres_SkinCancer)
rownames(allDepMap_kd.prob_SkinCancer)
rownames(allDepMap_copynumber_SkinCancer)
rownames(allDepMap_expression_SkinCancer)
```

We generated a new matrix (drivermutations.knockdown) which contains the knockdown data of the mutated genes from Drivermutation.expr. We look at the dimension of this new matrix
```{r}
drivermutations.knockdown = allDepMap_kd.ceres_SkinCancer[which(rownames(allDepMap_kd.ceres_SkinCancer) %in% rownames(Drivermutation.expr)),]
dim(drivermutations.knockdown)
```

We generated a new matrix (drivermutations.knockdown.prob) which contains the knockdown.prob data of the mutated genes from Drivermutation.expr. We look at the simension of thsi new matrix
```{r}
drivermutations.knockdown.prob = allDepMap_kd.prob_SkinCancer[which(rownames(allDepMap_kd.prob_SkinCancer) %in% rownames(Drivermutation.expr)),]
dim(drivermutations.knockdown.prob)
```

We generated a new matrix (drivermutations.copynumber) which contains the copynumber data of the mutated genes from Drivermutation.expr and look at its dimension.
````{r}
drivermutations.copynumber = allDepMap_copynumber_SkinCancer[which(rownames(allDepMap_copynumber_SkinCancer) %in% rownames(Drivermutation.expr)),]
dim(drivermutations.copynumber)
```

We generated a new matrix (drivermutations.expression) which contains the expression data of the mutated genes from Drivermutation.expr and looked at its dimension.
```{r}
drivermutations.expression = allDepMap_expression_SkinCancer[which(rownames(allDepMap_expression_SkinCancer) %in% rownames(Drivermutation.expr)),]
dim(drivermutations.expression)
```

Generating a heatmap of the knockdown data and the knockdown.prob data
```{r}
heatmap(as.matrix(drivermutations.knockdown))
heatmap(as.matrix(drivermutations.knockdown.prob))
```

K-measn clustering and scatter plot
installed this package to get the plots
```{r}
install.packages('fpc') ; library(fpc)
```

Proceeding a k-means with 4 centers and plotting this as a scatter plot.
```{r}
km = kmeans(t(targetexpression), centers = 4)
plotcluster(t(targetexpression), km$cluster)
```
Experimenting with different centerns -> with 3 centers we have the best plot
```{r}
km = kmeans(x = t(targetexpression), centers = 3, nstart = 10)
plotcluster(t(targetexpression), km$cluster)
```

Bind targetexpression und drivermutations.expression for a following PCA.
```{r}
rbind(drivermutations.expression, targetexpression)
PCA <- rbind(drivermutations.expression, targetexpression)
```

Executing the PCA 
```{r}
pca = prcomp(t(PCA), center = F, scale. = F)
show(pca)
```

Summary of the PCA
```{r}
summary(pca)
```
90% of our data is located in PC1, nearly all informations can be shown in PC1
str() to have a look at our PCA objects 
```{r}
str(pca)
```

Plotting PCA
```{r}
plot(pca, type = "l")
```

a new package is needed for following plotting
```{r}
install_github("vqv/ggbiplot")
library(ggbiplot)
```
```{r}
ggbiplot(pca)
```

pca Punkte als Zelllinien darstellen 
ggbiplot(pca, labels=rownames(pca$x))
#PCA für PC2vsPC3
ggbiplot(pca, choices = 2:3)
#PCA für drivermutations.knockdown
pca = prcomp(drivermutations.knockdown, center = F, scale. = F)
summary(pca)
str(pca)
plot(pca, type = "l")
library(ggbiplot)
ggbiplot(pca)
ggbiplot(pca, choices = 2:3)
ggbiplot(pca, labels=rownames(pca$x))
#PCA für drivermutations.knockdown.prob
pca = prcomp(drivermutations.knockdown.prob, center = F, scale. = F)
summary(pca)
str(pca)
plot(pca, type = "l")
library(ggbiplot)
ggbiplot(pca)
ggbiplot(pca, choices = 2:3)
#PCA für drivermutations.copynumber
pca = prcomp(drivermutations.copynumber, center = F, scale. = F)
summary(pca)
str(pca)
plot(pca, type = "l")
#fällt auf, dass der Knick etwas anders ist als die pca´s davor. Bedeutung ?
library(ggbiplot)
ggbiplot(pca)
#kann man gut erkennen
ggbiplot(pca, choices = 2:3)
#PCA von driver knockdown und prob.
rbind(drivermutations.knockdown.prob, drivermutations.knockdown)
PCA2 <- rbind(drivermutations.knockdown.prob, drivermutations.knockdown)
pca = prcomp(PCA2, center = F, scale. = F)
summary(pca)
plot(pca, type = "l")
library(ggbiplot)
ggbiplot(pca)
ggbiplot(pca, choices = 2:3)
ggbiplot(pca, labels=rownames(pca$x))