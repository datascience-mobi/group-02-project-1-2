---
title: "Group 02 - Skin Cancer"
author: "Leonie Thomas, Isabel Potthof, Elif Tosun and Marlene Khin"
date: "24.07.2019"
output:
  html_document: default
  pdf_document: default
---
#  <span style="color:orange">**Preparations**</span>

# 1.We need to load all needed packages:
```{r message=FALSE, warning=FALSE}
library(reshape2)
library(ggplot2)    
library(gridExtra)    
library(reshape2)    
library(data.table)  
library(cluster)  
library(rstudioapi)  
library(pheatmap)  
library(caret)  
library(tidyverse)  
library(dendextend)  
library(factoextra)  
library(devtools)  
library(ggfortify)  
library(rstudioapi)    
library(data.table)   
library(scales)   
library(stats)  
library(caTools)  
```

# 2. Setting the sys-path:
```{r eval=FALSE}
root.dir = dirname(rstudioapi::getSourceEditorContext()$path)
data = readRDS(paste0(root.dir,"/DepMap19Q1_allData.RDS"))
```

# 3. Loading the dataset:
```{r}
data = readRDS("/Users/eliftosun/Documents/GitHub/project-01-group-02/DepMap19Q1_allData.RDS")

```

# <span style="color:orange">**Part 1: Data Cleanup**</span>

## <span style="color:orange">**1.1 Extracting and splitting our data**</span>   
  
The mutation data is different from the other matrixes, so we define a new matrix only containing the mutation data
```{r}
mut <- data$mutation 
```
  
Additionally to the mutation matrix we want another matrix only containing the data which is not the mutation matrix.
We define which data should be excluded
```{r}
'%!in%' <- function(x,y)!('%in%'(x,y)) 
dt_new <- lapply(which(names(data) %!in% "mutation"), function(a) data[[a]]) 
names(dt_new) <- names(data)[which(names(data) %!in% "mutation")] 
```
  
defining the samples so we can extract only our cancer type of interest
```{r}
sample_case = c("Skin Cancer") 
``` 

We look at the annotation matrix an search only for the Primary diseases which match the previous defined sample case (Skin cancer) 
```{r}
samples = data$annotation$DepMap_ID[which(data$annotation$Primary.Disease == sample_case)]
```

extracting only the celllines with skin cancer as the primary disease from our matrices (dt_new) and save the new matrices in a new large list (processed_data)
```{r}
processed_data <- lapply(1:length(dt_new), function(a) {  
  dat_picker <- dt_new[[a]]  
  output <- dat_picker[,which(colnames(dat_picker) %in% samples)]
  output <- output[complete.cases(output),]
  output <- output[order(rownames(output)),]
  return(output)
})
names(processed_data) <- names(dt_new)

processed_data$annotation <- data$annotation[which(data$annotation$DepMap_ID %in% samples),]
```

Now we extract our cellines from the mutation data
```{r}
ids = which(names(mut) %in% samples) 
allDepMap_mutation_SkinCancer = lapply(ids, function(a) {
  mut[[a]]})
```

Losing the mutations which are not deleterious meaning not interesting to us
```{r}
allDepMap_mutation_SkinCancer = lapply(1:34, function(a) {allDepMap_mutation_SkinCancer[[a]][which(allDepMap_mutation_SkinCancer[[a]][,"isDeleterious"]== TRUE), ]})
```

losing all the genes which are not in every data frame 
```{r}
 a <- unique(c(rownames(processed_data[[1]]),rownames(processed_data[[2]]),rownames(processed_data[[3]]),rownames(processed_data[[4]])))

i <- 1
out <- vector("character", length(seq_along(1:16970)))
for (x in seq_along(a)) {
  if(a[x] %in% rownames(processed_data$expression) & a[x] %in% rownames(processed_data$copynumber) & a[x] %in% rownames(processed_data$kd.ceres) & a[x] %in% rownames(processed_data$kd.prob))
  {out[i] <- a[x]
  i <- i+1
  } 
}

processed_data2 <- processed_data

processed_data2 <- lapply(processed_data, function(a) {
  a <- a[which(rownames(a) %in% out),]
  return(a)
})
processed_data2$annotation <- processed_data$annotation
processed_data <- processed_data2
rm(processed_data2)
```

# <span style="color:orange">**Part 2: Data vizualisation**</span>  

## <span style="color:orange">**2.1 Preparing our data for plotting**</span>

Creating new data for plotting out of our data of interest
```{r, warning=FALSE, error=FALSE, message=FALSE}
finalPlottingData <- lapply(1:(length(processed_data)-1), function(a) {
  dtPicker <- processed_data[[a]]
  out <- melt(dtPicker) 
  out$Gene <- rep(rownames(dtPicker), ncol(dtPicker)) 
  out$Case <- names(processed_data)[1:(length(processed_data)-1)][a] 
  colnames(out) <- c("Sample", "Value", "Gene", "Case") 
  return(out)
})
```

```{r}
names(finalPlottingData) <- names(processed_data)[1:(length(processed_data)-1)] 
lapply(finalPlottingData, head)[1:3]
```

## <span style="color:orange">**2.2 creating a heatmap with the kd.ceres values**</span>
+ not the whole matrix just the first ten genes and all the celllines  
+ to see if there are interactions between gene activity and cell proliferation  
+ take care blue means really, really significant p-value!  
```{r}
pheatmap(as.matrix(processed_data$kd.ceres[25:45, 1:34]), clustering_method = "ward.D2",border_color = "white", fontsize = 10, 
         main = paste0("kdCERES for potential 2nd site targets"),
         show_rownames = F, show_colnames = T,
         cutree_rows = 4,
         cutree_cols = 2, 
         fontsize_row=10)  
```
***   
> + the knockout of the different genes influences the cells in different ways 

## <span style="color:orange">**2.3 Plotting the mutation data**</span>
```{r}
singleGenes <- as.vector(unique(as.data.frame(rbindlist(lapply(seq_along(allDepMap_mutation_SkinCancer), function(a) {out <- as.data.frame(as.vector(unique(allDepMap_mutation_SkinCancer[[a]]$Hugo_Symbol)))}))))[,1])


geneCounts <- sapply(seq_along(singleGenes), function(a) {
  genePicker <- singleGenes[a] 
  sumGene <- lapply(seq_along(allDepMap_mutation_SkinCancer), function(b) {
    mutPicker <- allDepMap_mutation_SkinCancer[[b]] 
    out <- as.data.frame(length(which(mutPicker$Hugo_Symbol == genePicker))) 
    return(out)
  })
  geneCount <- colSums(as.data.frame(rbindlist(sumGene))) 
  return(geneCount)
})
names(geneCounts) <- singleGenes 
geneCounts <- as.data.frame(geneCounts) 
colnames(geneCounts) <- c("Value")
sortedGenCounts <- geneCounts[order(-geneCounts$Value), , drop = FALSE]
head(sortedGenCounts) 
```
***
> interpration 

## <span style="color:orange">**2.4 Creating boxplots of expression and mutation data to get an overview of our data**</span>
```{r}
ggplot(data = finalPlottingData$expression, aes(x=Sample, y=Value)) +
  geom_boxplot(aes(fill = Sample), outlier.size = 0.1, outlier.alpha = 0.2) + 
  theme_bw(base_size = 7) + 
  theme(legend.position= "none", 
        legend.direction="horizontal", 
        plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        legend.title= element_blank(), 
        axis.title.x = element_blank(), 
        strip.text.y = element_text(angle = 90)) 
```
***
> there are outliers in every cellline which can be examined
*** 

```{r}
geneCounts <- cbind(geneCounts, "Mutations per Gene")

ggplot(data = geneCounts, aes(x="Mutations per Gene", y=Value)) +
  geom_boxplot(aes(fill = "Mutations per Gene"), outlier.size = 2, outlier.alpha = 0.2) + 
  theme_bw(base_size = 7) + 
  theme(legend.position= "none", 
        legend.direction="horizontal", 
        plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 0, vjust = 0.5, hjust= 0.5, size = 10), 
        legend.title= element_blank(), 
        axis.title.x = element_blank(), 
        strip.text.y = element_text(angle = 90)) 
```
***
> only a few genes are often mutated, so it should be good to define driver mutations
***

## <span style="color:orange">**2.5 Extact the data for the top 40**</span>
```{r}
plotData <- sortedGenCounts[1:10, ,drop = FALSE]
topDriverGenes <- rownames(plotData)

dataTopDriverGenes <- lapply(1:length(processed_data), function(a) { 
  dat_picker <- processed_data[[a]] 
  output <- dat_picker[which(rownames(dat_picker) %in% topDriverGenes),]
  return(output)
})
names(dataTopDriverGenes) <- names(dt_new)
lapply(dataTopDriverGenes, head)[1]
```


Extract the data for epression and ceres
```{r]}
driverexpression <- dataTopDriverGenes$expression
driverkd.ceres <- dataTopDriverGenes$kd.ceres
```

putting the names of the matrixes in one allDep_mutation
```{r}
names(allDepMap_mutation_SkinCancer) <- samples

OneMatrix <- data.frame()
for (i in c(1:34)) {
  OneMatrix <- rbind(OneMatrix, allDepMap_mutation_SkinCancer[[i]][,Hugo_Symbol:DepMap_ID])
}

ZelllinesMutations <- OneMatrix[which(OneMatrix$Hugo_Symbol %in% topDriverGenes ),]
ZelllinesMutations <- cbind(ZelllinesMutations$Hugo_Symbol, ZelllinesMutations$DepMap_ID)
```

## <span style="color:orange">**2.6 Plotting only the top 10 genes -> driver mutations**</span>
```{r}
plotData <- sortedGenCounts[1:10, ,drop = FALSE]

plotData$Gene <- rownames(plotData) 

ggplot(data = plotData) +
  (geom_bar(mapping = aes(x = Gene, y = Value), stat = "identity")) +
  theme_bw(base_size = 7) + 
  theme(legend.position= "none", 
        legend.direction="horizontal", 
        plot.title = element_text(hjust = 0.5), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), 
        axis.text.y = element_text(angle = 90, vjust = 0.5, hjust=1, size = 10), 
        legend.title= element_blank(), 
        axis.title.x = element_blank(), 
        strip.text.y = element_text(angle = 90)) 
```